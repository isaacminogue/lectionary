<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<html>

    <body>

        <menu>

            <button class='navigate left' onclick="app.backOnClick()">
                <svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 0.25C6.41421 0.25 6.75 0.585786 6.75 1V9.18934L10.4697 5.46967C10.7626 5.17678 11.2374 5.17678 11.5303 5.46967C11.8232 5.76256 11.8232 6.23744 11.5303 6.53033L6.53033 11.5303C6.23744 11.8232 5.76256 11.8232 5.46967 11.5303L0.46967 6.53033C0.176777 6.23744 0.176777 5.76256 0.46967 5.46967C0.762563 5.17678 1.23744 5.17678 1.53033 5.46967L5.25 9.18934V1C5.25 0.585786 5.58579 0.25 6 0.25Z"/>
                </svg>
            </button>
            
            <div class='radio'>

                <input 
                    type="radio" 
                    id="morning-radio-option" 
                    name="time-of-day-radio-input" 
                    value="morning"
                    onchange="app.morningEveningOnChange()">
                <label class='toggle' for="morning-radio-option">Morning</label>

                <input 
                    type="radio" 
                    id="evening-radio-option" 
                    name="time-of-day-radio-input" 
                    value="evening"
                    onchange="app.morningEveningOnChange()">
                <label class='toggle' for="evening-radio-option">Evening</label>

                <div class='thumb'></div>
            </div>

            <button class='navigate right' onclick="app.forwardOnClick()">
                <svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 0.25C6.41421 0.25 6.75 0.585786 6.75 1V9.18934L10.4697 5.46967C10.7626 5.17678 11.2374 5.17678 11.5303 5.46967C11.8232 5.76256 11.8232 6.23744 11.5303 6.53033L6.53033 11.5303C6.23744 11.8232 5.76256 11.8232 5.46967 11.5303L0.46967 6.53033C0.176777 6.23744 0.176777 5.76256 0.46967 5.46967C0.762563 5.17678 1.23744 5.17678 1.53033 5.46967L5.25 9.18934V1C5.25 0.585786 5.58579 0.25 6 0.25Z"/>
                </svg>
            </button>

        </menu>

        <h1 id='greeting'></h1>

        <select id="date-select" onchange="app.dateSelectOnChange()"></select>

        <p id="no-readings-message" style="display:none">There are no readings on Sundays yet</p>

        <div id="scriptures-section" style="display:none">
            <ul>
                <li><a id="psalm"></a></li>
                <li><a id="old-testament"></a></li>
                <li><a id="new-testament"></a></li>
            </ul>
        </div>

        <div class='action'>
            <a id="play-all-button">Play all</a> 
            <select id="audio-version-select" onchange="app.audioVersionSelectOnChange()">
                <option value="dolan/msg" selected="selected">MSG</option>
                <option value="mclean/niv">NIV</option>
                <option value="breathe/nlt">NLT</option>
            </select>
        </div>
       
        <div class='action primary'>
            <a id="read-all-button">Read all</a> 
            <select id="reading-version-select" onchange="app.readingVersionSelectOnChange()">
                <option value="NIV" selected="selected">NIV</option>
                <option value="MSG">MSG</option>
                <option value="NLT">NLT</option>
            </select>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="data.js"></script>
        <script>

            class App {
                
                // control fields
                #data;
                #masterDateKey;
                #morningOrEvening;
                #readingVersion;
                #audioVersion;

                constructor(){
                    this.#data = new Data().getData();
                }

                initialisePage() {

                    // set date to today
                    var now = new Date();
                    this.#masterDateKey =  this.#convertDateToDateKey(now);

                    // work out morning/evening default to show
                    this.#morningOrEvening = this.#checkCurrentTime(now);
                    this.#setRadioOption(this.#morningOrEvening)                

                    // populate the dropdown with all the dates, and select the current one
                    var $dropdown = $("#date-select");
                    Object.keys(this.#data).forEach(date => {
                        var text = this.#data[date].date_pretty;
                        var option = $("<option />").val(date).text(text);
                        $dropdown.append(option);
                    });
                    $(`#date-select option[value="${this.#masterDateKey}"]`).attr("selected",true);

                    this.#audioVersion = $("#audio-version-select").val();
                    this.#readingVersion = $("#reading-version-select").val();

                    // now fill in the data for the day
                    this.#refreshPageData();
                }


                dateSelectOnChange() {
                    this.#masterDateKey = $("#date-select").val();
                    this.#refreshPageData();
                }

                backOnClick() {
                    this.#masterDateKey = this.#getAdjacentDateKey(this.#masterDateKey, -1);
                    this.#refreshPageData();
                }

                forwardOnClick() {
                    this.#masterDateKey = this.#getAdjacentDateKey(this.#masterDateKey, 1);
                    this.#refreshPageData();
                }

                morningEveningOnChange() {
                    this.#morningOrEvening = $("input[name='time-of-day-radio-input']:checked").val();
                    this.#setRadioOption(this.#morningOrEvening);
                    this.#refreshPageData();
                }

                audioVersionSelectOnChange() {
                    this.#audioVersion = $("#audio-version-select").val();
                    this.#refreshPageData();
                }

                readingVersionSelectOnChange() {
                    this.#readingVersion = $("#reading-version-select").val();
                    this.#refreshPageData();
                }

                // Private methods
                //----------------------------------------------------------------------------------

                #checkCurrentTime(date) {
                    // Set morning as 12am - 12pm
                    var hours = date.getHours();
                    var morning = hours >= 0 && hours <= 12;
                    return morning ? "morning" : "evening";
                }

                #refreshPageData() {
                    var todaysData = this.#data[this.#masterDateKey];

                    // select the right date in the dropdown
                    $('#date-select option:selected').attr("selected",false);
                    $(`#date-select option[value="${this.#masterDateKey}"]`).attr("selected",true);
                    
                    // populate the greeting
                    if(this.#morningOrEvening === "morning"){
                        $("#greeting").text("Ata m\u0101rie.");
                    }
                    else {
                        $("#greeting").text("Po m\u0101rie.");
                    }
                    
                    // populate the scripture readings
                    var scriptures = todaysData[this.#morningOrEvening]["readings"];
                    var readingParams = todaysData[this.#morningOrEvening]["reading_link"];
                    var audioParams = todaysData[this.#morningOrEvening]["audio_link"];
                    var readingParamsArray = readingParams.split("%3B+");

                    if(scriptures[0] === ""){ // TODO: change the data to be empty/null, this is kinda weird..
                        $("#no-readings-message").show();
                        $("#scriptures-section").hide();
                    }
                    else {
                        $("#no-readings-message").hide();
                        $("#scriptures-section").show();

                        $("#psalm").text(scriptures[0]);
                        $("#psalm").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParamsArray[0]}`);

                        $("#old-testament").text(scriptures[1]);
                        $("#old-testament").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParamsArray[1]}`);

                        $("#new-testament").text(scriptures[2]);
                        $("#new-testament").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParamsArray[2]}`);

                        $("#play-all-button").attr("href", `https://www.biblegateway.com/audio/${this.#audioVersion}/${audioParams}`);
                        $("#read-all-button").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParams}`);
                    }
                }

                #padToTwoDigits(number) {
                    return `0${number}`.slice(-2); // slice here returns the last two characters
                }

                #convertDateToDateKey(date) {
                    var year = date.getFullYear();
                    var month = this.#padToTwoDigits(date.getMonth() + 1); // getMonth is zero based...?
                    var day = this.#padToTwoDigits(date.getDate()); // getDate returns the day of the month...?
                    return `${year}/${month}/${day}`;
                }

                #getAdjacentDateKey(dateKey, numberModifier) {
                    var date = new Date(dateKey.replace(/\//g,'-'));

                    var newDate = new Date();
                    newDate.setDate(date.getDate() + numberModifier);

                    return this.#convertDateToDateKey(newDate);
                }

                #setRadioOption(timeOfDay) {
                    var morningRadioEl = document.querySelector("#morning-radio-option");
                    var eveningRadioEl = document.querySelector("#evening-radio-option");
                    var root = document.querySelector(':root');
                    if (timeOfDay === "morning") {
                        morningRadioEl.checked = true;
                        root.style.setProperty('--foreground', 'rgba(0,0,0,1)');
                        root.style.setProperty('--background', 'rgba(255,255,255,1)');

                        root.style.setProperty('--toggle-base', 'rgba(0,0,0,0.05)');
                        root.style.setProperty('--toggle-stage', 'rgba(0,0,0,0.05)');
                        root.style.setProperty('--toggle-select', 'rgba(0,0,0,0.1)');

                        root.style.setProperty('--toggle-checked-base', 'rgba(0,0,0,1)');
                        root.style.setProperty('--toggle-checked-stage', 'rgba(255,255,255,0.2)');
                        root.style.setProperty('--toggle-checked-select', 'rgba(255,255,255,0.25)');
                    } else {
                        eveningRadioEl.checked = true;
                        root.style.setProperty('--background', 'rgba(0,0,0,1)');
                        root.style.setProperty('--foreground', 'rgba(255,255,255,1)');

                        root.style.setProperty('--toggle-base', 'rgba(255,255,255,0.2)');
                        root.style.setProperty('--toggle-stage', 'rgba(255,255,255,0.05)');
                        root.style.setProperty('--toggle-select', 'rgba(255,255,255,0.1)');

                        root.style.setProperty('--toggle-checked-base', 'rgba(255,255,255,1)');
                        root.style.setProperty('--toggle-checked-stage', 'rgba(0,0,0,0.05)');
                        root.style.setProperty('--toggle-checked-select', 'rgba(0,0,0,0.1)');
                    }
                }

            }

            var app = new App();

            // The script entrypoint (kicks off when jquery is loaded)
            //--------------------------------------------------------
            $(document).ready(function() {
                app.initialisePage();
            });

        </script>

    </body>
</html>